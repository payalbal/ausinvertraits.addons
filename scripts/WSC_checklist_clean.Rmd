---
title: "Cleaning the World Spider Catalog List"
author: "Fonti Kar"
date: "2023-05-08"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      include=FALSE)


```

# Cleaning the World Spider Catalog

Data can be accessed via the [WSC Data resources](https://wsc.nmbe.ch/dataresources) page. Bulk download is from their "Daily Species Exports" heading

## Load dependencies 

```{r}
pacman::p_load(tidyverse, skimr, arrow, janitor, worrms, here)
```

## Read in data

```{r}
wsc <- read_csv(here("data/WSC_taxonomic_checklist.csv"))
```

## Getting familiar with data

```{r}
skim(wsc)
```

## Precleaning 

Create a `scientific_name` variable

```{r}
wsc_scnm <- wsc |> 
  mutate(scientific_name = case_when(
    is.na(subspecies) ~ paste(genus, species),
    !is.na(subspecies) ~ paste(genus, species, subspecies)
  )
  ) |> 
  select(speciesId:species_lsid, scientific_name, family:distribution)

```

## Remove non-Australian species

```{r}
oz_wsc <- wsc_scnm |> 
  filter(distribution == "Australia")
```

## Remove improper names

```{r}
source(here("scripts/remove_improper_names_v2.R"))

oz_wsc_clean_names <- oz_wsc |> 
  pull(scientific_name) |> 
  remove_improper_names_v2()
```

There were `r length(oz_wsc_clean_names$improper_species)` improper species and `r length(oz_wsc_clean_names$incomplete_species)` species were found.


## Remove marine species

No marine species identified

```{r, eval=FALSE}
wm_oz_wsc <- map(oz_wsc |> pull(scientific_name),
    possibly(~ wm_records_names(.x, marine_only = FALSE))
    )
```

## Matches to AFD

```{r}
afd_may <- read_csv(here("data/afd_May2023_clean.csv"))

matches <- intersect(oz_wsc |> pull(scientific_name), afd_may |> pull(FULL_NAME)) 

# Flag in WSC
```

There were `r length(matches)` matches or `r length(matches)/nrow(oz_wsc)` found between Australian taxa in the WSC and the AFD. These include: 

```{r, include=TRUE}
matches
```

## New taxa additions

```{r}
new <- setdiff(oz_wsc |> pull(scientific_name), afd_may |> pull(FULL_NAME)) 
```

There were `r length(new)` NEW taxa or `r length(new)/nrow(oz_wsc)` found in the WSC that we can add to the AFD. These include: 

```{r, include=TRUE}
new
```

